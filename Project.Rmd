---
author: "print('Hello World!')"
title: "Data Challenge"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

# Makes sure that the required packages are properly installed; if they are not installed, R helps to install them
# Retrieved on 10/14/23 from - https://stackoverflow.com/questions/4090169/elegant-way-to-check-for-missing-packages-and-install-them
required_packages <- c("tidyverse", "glmnet", "tidymodels", "caret", "car", "Metrics", "MASS", "pdp", "scales", "gganimate", "gifski", "patchwork", "randomForest", "kernlab", "caretEnsemble", "vip", "gridExtra")
new_packages <- required_packages[!(required_packages %in% installed.packages()[, "Package"])]
if (length(new.packages)) {
  install.packages(new_packages)
}

library(tidyverse)
library(glmnet)
library(tidymodels)
library(Metrics)
library(car)
library(caret)
library(MASS)
library(pdp)
library(usmap)
library(scales)
library(patchwork)
library(gganimate)
library(gifski)
library(kernlab)
library(caretEnsemble)
library(vip)
library(gridExtra)


my_theme <- theme_minimal() +
  theme(
    axis.text = element_text(size = 16, color = "black"),
    axis.title = element_text(size = 18, color = "black", face = "plain"),
    title = element_text(size = 18, color = "black", face = "bold"),
    legend.text = element_text(size = 16, color = "black"),
    legend.title = element_text(
      color = "black",
      size = 16, margin =
        ggplot2::margin(t = 0, r = 20, b = 0, l = 0, unit = "pt")
    ),
    strip.text = element_text(size = 20, color = "black"),
    panel.grid.minor = element_blank(),
    panel.background = element_rect(fill = "#F7F7F7"),
    panel.border = element_rect(fill = NA, color = "#0c0c0c", linewidth = 0.6),
    legend.position = "bottom",
    panel.spacing = unit(15, "pt")
  )

theme_set(my_theme)


options(warn = -1)
```


```{r read-data, echo = FALSE}
energy_prod <- read_csv("Energy Production.csv") %>%
  mutate(unit = "GWh")

charging_stations <- read_csv("EV Charging Stations - EV Chargers.csv") %>%
  mutate(unit = "charging points")

ev_data <- read_csv("EV Data - EV Data.csv")
```


### Questions to Answer

- How might energy production trends be related to the adoption of EVs? What does this say about attitudes toward green technologies around the world?

- What factors are the best predictors of future EV adoption? Which countries are best positioned to embrace the transition to EVs?

---

### Motivation 

```{r, fig.height = 6, fig.width = 10}
p <- list()

p[["Total Vehicles"]] <- ev_data %>%
  filter(country == "World") %>%
  filter(unit != "percent") %>%
  group_by(year, parameter, powertrain) %>%
  summarize(total = sum(value)) %>%
  mutate(powertrain = forcats::fct(powertrain,
    levels = c("BEV", "PHEV", "FCEV", "EV")
  )) %>%
  ungroup() %>%
  filter(parameter %in% c("EV sales", "EV stock")) %>%
  ggplot(aes(x = year, y = total, color = parameter)) +
  geom_point(size = 2) +
  geom_line(linewidth = 1) +
  facet_wrap(~powertrain) +
  scale_y_log10(labels = scales::comma) +
  labs(
    color = "",
    x = "",
    y = "Total Vehicles"
  ) +
  scale_color_manual(
    values = c("deepskyblue4", "orangered2"),
    labels = c(
      "EV stock" = "Stock",
      "EV sales" = "Sales"
    )
  ) +
  theme(
    axis.text = element_text(size = 13),
    axis.title = element_text(size = 15),
    title = element_text(size = 15),
    legend.text = element_text(size = 13),
    legend.title = element_text(
      size = 15, margin =
        ggplot2::margin(t = 0, r = 20, b = 0, l = 0, unit = "pt")
    ),
    strip.text = element_text(size = 15),
    legend.position = "right"
  )

# p[["Total Vehicles"]]
```


```{r, fig.height = 7, fig.width = 10}
p[["Share"]] <- ev_data %>%
  filter(country == "World") %>%
  filter(unit == "percent") %>%
  group_by(year, parameter, powertrain) %>%
  summarize(avg = mean(value)) %>%
  ungroup() %>%
  ggplot(aes(x = year, y = avg, color = parameter)) +
  geom_point(size = 2) +
  geom_line(linewidth = 1) +
  labs(
    color = "",
    x = "",
    y = "Average Share (%)\n[Of Total Car Fleet]"
  ) +
  scale_color_manual(
    values = c("deepskyblue4", "orangered2"),
    labels = c(
      "EV stock share" = "Stock",
      "EV sales share" = "Sales"
    )
  ) +
  theme(
    axis.text = element_text(size = 13),
    axis.title = element_text(size = 15),
    title = element_text(size = 15),
    legend.text = element_text(size = 13),
    legend.title = element_text(
      size = 15, margin =
        ggplot2::margin(t = 0, r = 20, b = 0, l = 0, unit = "pt")
    ),
    legend.position = "right"
  )


p[["Total Vehicles"]] / p[["Share"]] +
  plot_annotation(title = "Global EV Stocks & Sales") +
  plot_layout(guides = "collect") &
  theme(legend.position = "right")
```


> **Observation:**

- In general, the whole globe are moving towards the adoption of EVs. As evidenced by total vehicle sales, most people opt for BEVs, followed by PHEVs, and finally FCEVs. Naturally, with more demand comes more supply.

- Interestingly, the share of EV sales is increasing exponentially over the last few years. However, the share of EV stocks - although post-2019 seems to show some increasing trend - isn't growing as fast as the sales. 

- This essentially means that, out of all cars, people are gravitating towards buying EVs. On the other hand, the proportion of EV production have only started to pick up over the last few years.

- Let's look at the share of EV sales by country over the years (2011 - 2021).


```{r, fig.height = 6, fig.width = 12}
world <- map_data("world")

country_share <- ev_data %>%
  filter(!country %in% c("World", "EU27", "Europe", "Rest of the world")) %>%
  mutate(country = replace(country, country == "Korea", "South Korea")) %>%
  mutate(country = replace(country, country == "Turkiye", "Turkey")) %>%
  mutate(country = replace(country, country == "United Kingdom", "UK")) %>%
  filter(parameter == "EV sales share") %>%
  group_by(country, year) %>%
  summarize(avg = mean(value)) %>%
  mutate(bins = case_when(
    avg >= 0.0001 & avg < 1 ~ "< 1%",
    avg >= 1 & avg < 5 ~ "1% - 5%",
    avg >= 5 & avg < 10 ~ "5% - 10%",
    avg >= 10 & avg <= 86 ~ "> 10%"
  )) %>%
  mutate(bins = forcats::fct(bins, levels = c(
    "> 10%", "5% - 10%",
    "1% - 5%", "< 1%"
  )))

base_map <- world %>%
  ggplot(aes(x = long, y = lat, group = group)) +
  geom_polygon(color = "black", fill = "white") +
  theme(
    axis.text = element_blank()
  ) +
  labs(x = "", y = "")


shares_over_time <- world %>%
  inner_join(country_share, by = c("region" = "country"))


num_years <- max(country_share$year) - min(country_share$year) + 1

animation <- base_map +
  geom_polygon(data = shares_over_time, aes(
    x = long, y = lat, group = group,
    fill = bins
  )) +
  scale_fill_manual(values = c("#030e36", "#0570b0", "#74a9cf", "#eaf4f9")) +
  labs(fill = "Sales Share") +
  theme(legend.position = "bottom") +
  transition_time(year) +
  ggtitle("EV Sales Share in Available Countries",
    subtitle = "Year: {frame_time}"
  )

animate(animation,
  nframes = num_years, fps = 0.7, renderer = gifski_renderer("sales_share.gif"), height = 768, width = 1366,
  res = 150
)

country_share %>%
  filter(country %in% c("Sweden", "Norway", "Finland", "Denmark")) %>%
  filter(year >= 2019)
```

> **Observation:**

- We can clearly see that based on the available data, all countries are now slowly inching towards wide-scale EV adoption.

- In 2021, 86% of Norway's car sales were of electric-powered vehicles! The Nordic government's carbon-neutral plan is possibly a huge contributing factor to this.

- That being said, we should not be deceived by the coloring of the map. The legend that corresponds to each color tells us exactly how far off are we from a 50% adoption of EVs (let alone 100%). To put it concisely, the share of EV sales is still very low in many countries.

- But the increasing sales share is promising enough to infer that in the future, we will eventually embrace EVs.

- Our goal now is to identify which factors contribute to EV adoption the most. Along with that, we aim to pinpoint the countries that are most suited for a massive transition to EVs.

- Although our available data only spans 48 nations (about a quarter of all countries), this is perhaps a good enough sample size to ensure external validity in our results.

- We press onwards by trying to find the best predictors of future EV adoption.


---

### Analyzing Best Predictors of Future EV Adoption

- First, we try to create a linear model. We will flatten out (read: pivot_wider()) all the datasets and then carry out the necessary machine learning steps.

- This includes splitting the combined data (all 3 files) into training and test sets, applying standard scaling on all numerical variables, and performing LASSO regularization to determine the best features.

- Then, we fit a linear model and perform bidirectional stepwise selection to get our final model. 


##### Setup: Imputations

- But before that, we noticed that the charging stations for `Austria` to be a little problematic. It does not make sense to have 0.1 charging points. So, we will have to perform some log-linear interpolation on the relevant rows. We can check the validity of this log-linear interpolation by looking at other neighboring (EU27) countries.

```{r, fig.width = 8}
# Setup
ev_data <- ev_data %>%
  filter(!country %in% c("World", "EU27", "Europe", "Rest of the world")) %>%
  mutate(country = replace(country, country == "Korea", "South Korea")) %>%
  mutate(country = replace(country, country == "Turkiye", "Turkey")) %>%
  mutate(country = replace(country, country == "United Kingdom", "UK"))

energy_prod <- energy_prod %>%
  filter(!country %in% c(
    "OECD Americas", "OECD Asia Oceania", "OECD Europe",
    "OECD Total", "IEA Total"
  )) %>%
  mutate(country = replace(country, country == "Korea", "South Korea")) %>%
  mutate(country = replace(country, country == "Republic of Turkiye", "Turkey")) %>%
  mutate(country = replace(country, country == "United Kingdom", "UK")) %>%
  mutate(country = replace(country, country == "United States", "USA")) %>%
  mutate(country = replace(country, country == "Slovak Republic", "Slovakia")) %>%
  mutate(country = replace(country, country == "People's Republic of China", "China"))

eu <- charging_stations %>%
  filter(country %in% c(
    "EU27", "Austria", "Belgium", "Bulgaria", "Croatia",
    "Cyprus", "Czech Republic", "Denmark", "Estonia",
    "Finland", "France", "Germany", "Greece", "Hungary",
    "Ireland", "Italy", "Latvia", "Lithuania", "Luxembourg",
    "Malta", "Netherlands", "Poland", "Portugal", "Romania",
    "Slovakia", "Slovenia", "Spain", "Sweden"
  ))

# Log-Linear interpolation: We have 0.1 charging points in Austria from 2011 - 2020. In 2021, there are 1600 charging points in Austria. So, this means that
# there are some mising data. To carry out this imputation, let's start with 0 and end with 1600. In between, set the values to be NA (because log-linear interpolation only works when there is missing data). By cross checking with EU27 as a whole and summing up the charging points in individual EU countries for 2011, we can deduce that starting with 0 is valid (EU27 and summation of charging points across individual countries are exactly equal in 2011, so if we change 0.1 to 0 for Austria, the data won't make any difference at all)
eu %>%
  mutate(eu = case_when(
    country == "EU27" ~ "EU",
    .default = "Country"
  )) %>%
  group_by(year, eu, powertrain) %>%
  summarize(total_stations = floor(sum(value))) %>%
  filter(year == 2011)

# Check to see if a log-linear relationship between years and # of charging ports is valid (Generally, it seems so!)
eu %>%
  filter(!country %in% c("EU27", "Austria")) %>%
  ggplot(aes(x = year, y = log(value), color = country)) +
  geom_point() +
  geom_line() +
  facet_wrap(~powertrain, scales = "free_y") +
  labs(
    y = "ln(Chg. Stations)", x = "", color = "Country",
    title = "Growth of EV Charging Ports in EU"
  )

# Perform the interpolations
austria_fast <- charging_stations %>%
  filter(country == "Austria" & powertrain == "Publicly available fast") %>%
  mutate(value = case_when(
    year == 2011 ~ 1, # 1 because log(1) = 0
    year == 2021 ~ value,
    .default = NA
  )) %>%
  mutate(log_val = log(value)) %>%
  mutate(log_val = approx(x = year, y = log_val, xout = year, rule = 2)$y) %>%
  mutate(value = round(exp(log_val))) %>%
  dplyr::select(-log_val)

austria_slow <- charging_stations %>%
  filter(country == "Austria" & powertrain == "Publicly available slow") %>%
  mutate(value = case_when(
    year == 2011 ~ 1, # 1 because log(1) = 0
    year == 2021 ~ value,
    .default = NA
  )) %>%
  mutate(log_val = log(value)) %>%
  mutate(log_val = approx(x = year, y = log_val, xout = year, rule = 2)$y) %>%
  mutate(value = round(exp(log_val))) %>%
  dplyr::select(-log_val)

# Fix the original charging_stations df
charging_stations <- charging_stations %>%
  filter(!country %in% c("Europe", "World")) %>%
  mutate(country = replace(country, country == "Korea", "South Korea")) %>%
  mutate(country = replace(country, country == "Turkiye", "Turkey")) %>%
  mutate(country = replace(country, country == "United Kingdom", "UK")) %>%
  filter(country != "Austria") %>%
  bind_rows(austria_fast) %>%
  bind_rows(austria_slow) %>%
  arrange(country)
```

- Moving on, we transform the datasets into a wide format respectively to obtain the variables that we want to regress against in our model.  

- We can then proceed with joining these datasets into a one table. A downside to this is that we would lose several countries since they do not have available data in all 3 columns.

```{r}
# Pivot wider
wide_cs <- charging_stations %>%
  dplyr::select(-unit) %>%
  pivot_wider(names_from = "powertrain", values_from = value) %>%
  rename(
    charging_sttns_fast = `Publicly available fast`,
    charging_sttns_slow = `Publicly available slow`
  )


# Data for Oil Displacement / EV Electricity Demand is almost non-existent; perhaps we can remove them later
wide_ev <- ev_data %>%
  mutate(stock_sales = paste0(parameter, "_", powertrain)) %>%
  mutate(stock_sales = case_when(
    stock_sales == "EV sales share_EV" ~ "Total_Sales",
    stock_sales == "EV stock share_EV" ~ "Total_Stocks",
    stock_sales == "EV sales_BEV" ~ "BEV_Sales",
    stock_sales == "EV sales_PHEV" ~ "PHEV_Sales",
    stock_sales == "EV sales_FCEV" ~ "FCEV_Sales",
    stock_sales == "EV stock_BEV" ~ "BEV_Stock",
    stock_sales == "EV stock_PHEV" ~ "PHEV_Stock",
    stock_sales == "EV stock_FCEV" ~ "FCEV_Stock",
    stock_sales == "Oil displacement Mbd_EV" ~ "Oil_Disp_MBD",
    stock_sales == "Oil displacement, million lge_EV" ~ "Oil_Disp_mil_lge",
    stock_sales == "Electricity demand_EV" ~ "EV_Elec_Demand_GWh"
  )) %>%
  dplyr::select(-parameter, -powertrain, -unit) %>%
  pivot_wider(names_from = "stock_sales", values_from = "value")


# Net Electricity Production:
# Total Renewables (Hydro, Geo, Solar, Wind, Other) = Hydro + Geo + Solar + Wind + Combustible Renewables + Other Renewables //
# Total Combustible Fuels // = Combustible Renewables + Oil and Petroleum Products + Other Combustible Non-Renewables // + Coal, Peat and Manufactured Gases + Natural Gas
# Electricity = Total Combustible Fuels + Total Renewables + Nuclear - Combustible Renewables
# Remove some of these variables to prevent multi-collinearity
wide_energy_prod <- energy_prod %>%
  group_by(country, balance, product, year) %>%
  summarize(total = sum(value)) %>%
  ungroup() %>%
  filter(!(balance == "Net Electricity Production" & product %in% c("Total Combustible Fuels", "Not Specified", "Other Combustible Non-Renewables", "Other Renewables"))) %>%
  mutate(variables = paste0(balance, "_", product)) %>%
  mutate(variables = case_when(
    str_starts(variables, "Net Electricity Production_") ~ paste0(product, " (Net_Produce)"),
    variables == "Final Consumption (Calculated)_Electricity" ~ "Electricity_Cons",
    variables == "Distribution Losses_Electricity" ~ "Electricity_Distrib_Loss",
    variables == "Used for pumped storage_Electricity" ~ "Electricity_Pumped_Storage",
    variables == "Total Exports_Electricity" ~ "Electricity_Exports",
    variables == "Total Imports_Electricity" ~ "Electricity_Imports"
  )) %>%
  dplyr::select(-balance, -product) %>%
  pivot_wider(names_from = "variables", values_from = "total")
```


- Looking at the combined dataset, there seems to be missing values in several columns. While it is easy to just do drop_na(), we only have < 300 rows of data. Perhaps, imputing them might yield a more accurate model later.

```{r}
# More imputations

# 1. Net Electricity Production
combined_data <- wide_ev %>%
  inner_join(wide_energy_prod, by = c("country", "year")) %>%
  inner_join(wide_cs, by = c("country", "year")) %>%
  dplyr::select(-EV_Elec_Demand_GWh, -Oil_Disp_mil_lge, -Oil_Disp_MBD) %>% # Remove columns because data is on available for USA, India, China
  mutate(`Geothermal (Net_Produce)` = ifelse(is.na(`Geothermal (Net_Produce)`), 0, `Geothermal (Net_Produce)`)) %>%
  mutate(`Coal, Peat and Manufactured Gases (Net_Produce)` = ifelse(is.na(`Coal, Peat and Manufactured Gases (Net_Produce)`), 0, `Coal, Peat and Manufactured Gases (Net_Produce)`)) %>%
  mutate(`Nuclear (Net_Produce)` = ifelse(is.na(`Nuclear (Net_Produce)`), 0, `Nuclear (Net_Produce)`)) %>%
  mutate(`Solar (Net_Produce)` = ifelse(is.na(`Solar (Net_Produce)`), 0, `Solar (Net_Produce)`)) %>%
  mutate(`Solar (Net_Produce)` = ifelse(is.na(`Solar (Net_Produce)`), 0, `Solar (Net_Produce)`)) %>%
  mutate(`Natural Gas (Net_Produce)` = ifelse(is.na(`Natural Gas (Net_Produce)`), 0, `Natural Gas (Net_Produce)`)) %>%
  mutate(`Combustible Renewables (Net_Produce)` = ifelse(is.na(`Combustible Renewables (Net_Produce)`), 0, `Combustible Renewables (Net_Produce)`))


combined_data <- combined_data %>%
  rename(
    Coal_Share = `Coal, Peat and Manufactured Gases (Net_Produce)`,
    Combust_Renew_Share = `Combustible Renewables (Net_Produce)`,
    Electricity_Prod = `Electricity (Net_Produce)`,
    Geothermal_Share = `Geothermal (Net_Produce)`,
    Hydro_Share = `Hydro (Net_Produce)`,
    NaturalGas_Share = `Natural Gas (Net_Produce)`,
    Nuclear_Share = `Nuclear (Net_Produce)`,
    OilPetrol_Share = `Oil and Petroleum Products (Net_Produce)`,
    Solar_Share = `Solar (Net_Produce)`,
    Renewables_Share = `Total Renewables (Hydro, Geo, Solar, Wind, Other) (Net_Produce)`,
    Wind_Share = `Wind (Net_Produce)`
  )
```


```{r}
# 2. Charging Stations

# AUS - Interpolation because NA values are between available data
aus <- combined_data %>%
  filter(country == "Australia") %>%
  mutate(log_pub_fast = log(charging_sttns_fast)) %>%
  mutate(log_pub_fast = approx(x = year, y = log_pub_fast, xout = year, rule = 2)$y) %>%
  mutate(charging_sttns_fast = round(exp(log_pub_fast))) %>%
  dplyr::select(-log_pub_fast)

# GRE - Backfill since only 1 NA
gre <- combined_data %>%
  filter(country == "Greece") %>%
  mutate(log_pub_fast = log(charging_sttns_fast)) %>%
  mutate(log_pub_fast = approx(x = year, y = log_pub_fast, xout = year, rule = 2)$y) %>%
  mutate(charging_sttns_fast = round(exp(log_pub_fast))) %>%
  dplyr::select(-log_pub_fast)


# MEX - Backfill since only 1 NA
mex <- combined_data %>%
  filter(country == "Mexico") %>%
  mutate(log_pub_fast = log(charging_sttns_fast)) %>%
  mutate(log_pub_fast = approx(x = year, y = log_pub_fast, xout = year, rule = 2)$y) %>%
  mutate(charging_sttns_fast = round(exp(log_pub_fast))) %>%
  dplyr::select(-log_pub_fast)


# NED - Backfill since only 2 NAs and small values
ned <- combined_data %>%
  filter(country == "Netherlands") %>%
  mutate(log_pub_fast = log(charging_sttns_fast)) %>%
  mutate(log_pub_fast = approx(x = year, y = log_pub_fast, xout = year, rule = 2)$y) %>%
  mutate(charging_sttns_fast = round(exp(log_pub_fast))) %>%
  dplyr::select(-log_pub_fast)


# NOR - Backfill since only 1 NA
nor <- combined_data %>%
  filter(country == "Norway") %>%
  mutate(log_pub_fast = log(charging_sttns_fast)) %>%
  mutate(log_pub_fast = approx(x = year, y = log_pub_fast, xout = year, rule = 2)$y) %>%
  mutate(charging_sttns_fast = round(exp(log_pub_fast))) %>%
  dplyr::select(-log_pub_fast)


# ESP - Backfill since only 1 NA
esp <- combined_data %>%
  filter(country == "Spain") %>%
  mutate(log_pub_fast = log(charging_sttns_fast)) %>%
  mutate(log_pub_fast = approx(x = year, y = log_pub_fast, xout = year, rule = 2)$y) %>%
  mutate(charging_sttns_fast = round(exp(log_pub_fast))) %>%
  dplyr::select(-log_pub_fast)


# UK - Backfill since only 1 NA
uk <- combined_data %>%
  filter(country == "UK") %>%
  mutate(log_pub_fast = log(charging_sttns_fast)) %>%
  mutate(log_pub_fast = approx(x = year, y = log_pub_fast, xout = year, rule = 2)$y) %>%
  mutate(charging_sttns_fast = round(exp(log_pub_fast))) %>%
  dplyr::select(-log_pub_fast)


# USA - Extrapolate using linear regression
usa <- combined_data %>%
  filter(country == "USA") %>%
  mutate(log_pub_fast = log(charging_sttns_fast))

predict_usa <- usa %>%
  dplyr::select(year, log_pub_fast) %>%
  filter(is.na(log_pub_fast)) %>%
  dplyr::select(-log_pub_fast)

lm_usa <- lm(log_pub_fast ~ year, data = usa)
usa$log_pub_fast[is.na(usa$log_pub_fast)] <- predict(lm_usa, predict_usa)
usa <- usa %>%
  mutate(charging_sttns_fast = round(exp(log_pub_fast))) %>%
  dplyr::select(-log_pub_fast)


# SWE - Extrapolate using linear regression
swe <- combined_data %>%
  filter(country == "Sweden") %>%
  mutate(log_pub_fast = log(charging_sttns_fast))

predict_swe <- swe %>%
  dplyr::select(year, log_pub_fast) %>%
  filter(is.na(log_pub_fast)) %>%
  dplyr::select(-log_pub_fast)

lm_swe <- lm(log_pub_fast ~ year, data = swe)
swe$log_pub_fast[is.na(swe$log_pub_fast)] <- predict(lm_swe, predict_swe)
swe <- swe %>%
  mutate(charging_sttns_fast = round(exp(log_pub_fast))) %>%
  dplyr::select(-log_pub_fast)


combined_data <- combined_data %>%
  filter(!country %in% c(
    "Australia", "Greece", "Mexico", "Netherlands", "Norway",
    "Spain", "UK", "USA", "Sweden"
  )) %>%
  bind_rows(aus, gre, mex, ned, nor, esp, uk, usa, swe)


# ISL - Backfill since only 1 NA
isl <- combined_data %>%
  filter(country == "Iceland") %>%
  mutate(log_pub_slow = log(charging_sttns_slow)) %>%
  mutate(log_pub_slow = approx(x = year, y = log_pub_slow, xout = year, rule = 2)$y) %>%
  mutate(charging_sttns_slow = round(exp(log_pub_slow))) %>%
  dplyr::select(-log_pub_slow)


# IND - Backfill since only 1 NA
ind <- combined_data %>%
  filter(country == "India") %>%
  mutate(log_pub_slow = log(charging_sttns_slow)) %>%
  mutate(log_pub_slow = approx(x = year, y = log_pub_slow, xout = year, rule = 2)$y) %>%
  mutate(charging_sttns_slow = round(exp(log_pub_slow))) %>%
  dplyr::select(-log_pub_slow)


# JPN - Using linear regression was a little inaccurate, but the rate of change for both types of charging port is quite similar, so use rate of change
jpn <- combined_data %>%
  filter(country == "Japan") %>%
  mutate(
    rate_change_fast = 1 + (charging_sttns_fast - lag(charging_sttns_fast)) / lag(charging_sttns_fast),
    rate_change_slow = 1 + (charging_sttns_slow - lag(charging_sttns_slow)) / lag(charging_sttns_slow)
  )


# Fill in the missing values in `publicly_available_slow` using rate_change_fast
for (i in sum(is.na(jpn$charging_sttns_slow)):1) {
  jpn$charging_sttns_slow[i] <- jpn$charging_sttns_slow[i + 1] / jpn$rate_change_fast[i + 1]
}

jpn <- jpn %>%
  dplyr::select(-c(rate_change_fast, rate_change_slow)) %>%
  mutate(charging_sttns_slow = round(charging_sttns_slow))


# NZL - Backfill since only 1 NA
nzl <- combined_data %>%
  filter(country == "New Zealand") %>%
  mutate(log_pub_slow = log(charging_sttns_slow)) %>%
  mutate(log_pub_slow = approx(x = year, y = log_pub_slow, xout = year, rule = 2)$y) %>%
  mutate(charging_sttns_slow = round(exp(log_pub_slow))) %>%
  dplyr::select(-log_pub_slow)


# TUR - Backfill (# of charging ports is considerably small for any prediction methods to work well)
tur <- combined_data %>%
  filter(country == "Turkey") %>%
  mutate(log_pub_slow = log(charging_sttns_slow)) %>%
  mutate(log_pub_slow = approx(x = year, y = log_pub_slow, xout = year, rule = 2)$y) %>%
  mutate(charging_sttns_slow = round(exp(log_pub_slow))) %>%
  dplyr::select(-log_pub_slow)

combined_data <- combined_data %>%
  filter(!country %in% c("Iceland", "India", "Japan", "New Zealand", "Turkey")) %>%
  bind_rows(isl, ind, jpn, nzl, tur)
```


```{r}
# 3. Electricity Consumption / Distribution Loss

# Electricity (Produced) = Distribution Loss + Consumption + Exports - Imports + Pumped Storage //

# https://www.ceicdata.com/en/brazil/environmental-energy-production-and-consumption/br-electric-power-transmission-and-distribution-losses--of-output
# https://www.statista.com/statistics/302292/china-electric-power-transmission-loss/#:~:text=China's%20power%20transmission%20losses%20amount,follows%20years%20of%20network%20improvement.
# https://www.statista.com/statistics/1233002/transmission-losses-share-electricity-by-region-india/
# Electricity Distribution Loss -
# China: 5%
# Brazil: 15.5%
# India: 20%

# Electricity Consumption -
# China: 5%
# Brazil: 15.5%
# India: 20%

loss_cons <- combined_data %>%
  filter(is.na(Electricity_Distrib_Loss)) %>%
  mutate(Electricity_Distrib_Loss = case_when(
    country == "Brazil" ~ 0.155 * Electricity_Prod,
    country == "China" ~ 0.05 * Electricity_Prod,
    country == "India" ~ 0.2 * Electricity_Prod
  ))


# https://www.eia.gov/international/data/world/electricity/electricity-consumption?pd=2&p=0000002&u=0&f=A&v=mapbubble&a=-&i=none&vo=value&t=C&g=00000000000000000000000000000000000000000000000001&l=249-ruvvvvvfvtvnvv1vrvvvvfvvvvvvfvvvou20evvvvvvvvvvnvvvs0008&s=315532800000&e=1546300800000&
# Electricity Consumption

brazil_cons <- c(543, 551, 547, 570) * 1e3
china_cons <- c(5510, 5826, 6323, 6734, 7097, 7386, 8110) * 1e3
india_cons <- c(1133, 1173, 1215, 1261, 1201, 1352) * 1e3

loss_cons[loss_cons$country == "Brazil", ]$Electricity_Cons <- brazil_cons
loss_cons[loss_cons$country == "China", ]$Electricity_Cons <- china_cons
loss_cons[loss_cons$country == "India", ]$Electricity_Cons <- india_cons

# Fix original data
combined_data <- combined_data %>%
  filter(!country %in% c("China", "Brazil", "India")) %>%
  bind_rows(loss_cons)
```


```{r}
# 4. Electricity Imports/Exports
# https://www.eia.gov/international/data/world/electricity/electricity-imports?pd=2&p=0000000000002&u=0&f=A&v=mapbubble&a=-&i=none&vo=value&&t=C&g=00000000000000000000000000000000000000000000000001&l=249-ruvvvvvfvtvnvv1vrvvvvfvvvvvvfvvvou20evvvvvvvvvvnvvvs0008&s=315532800000&e=1672531200000

exp <- combined_data %>%
  filter(is.na(Electricity_Exports))

chile_exp <- c(0.7, 0, 0, 0, 0) * 1e3
korea_exp <- c(0, 0) * 1e3
aus_exp <- c(0) * 1e3
isl_exp <- c(0, 0, 0, 0) * 1e3
jpn_exp <- c(0, 0, 0, 0, 0, 0, 0, 0) * 1e3
brazil_exp <- c(0, 0.2, 0.4, 0) * 1e3
china_exp <- c(19, 19, 19, 21, 22, 22, 20) * 1e3
india_exp <- c(6.7, 7.2, 8.5, 9.5, 9.4, 9.6) * 1e3

exp[exp$country == "Chile", ]$Electricity_Exports <- chile_exp
exp[exp$country == "South Korea", ]$Electricity_Exports <- korea_exp
exp[exp$country == "Australia", ]$Electricity_Exports <- aus_exp
exp[exp$country == "Iceland", ]$Electricity_Exports <- isl_exp
exp[exp$country == "Japan", ]$Electricity_Exports <- jpn_exp
exp[exp$country == "Brazil", ]$Electricity_Exports <- brazil_exp
exp[exp$country == "China", ]$Electricity_Exports <- china_exp
exp[exp$country == "India", ]$Electricity_Exports <- india_exp

combined_data <- combined_data %>%
  filter(!is.na(Electricity_Exports)) %>%
  bind_rows(exp)

imp <- combined_data %>%
  filter(is.na(Electricity_Imports))

chile_imp <- c(0, 0, 0, 0) * 1e3
korea_imp <- c(0, 0) * 1e3
aus_imp <- c(0) * 1e3
isl_imp <- c(0, 0, 0, 0) * 1e3
jpn_imp <- c(0, 0, 0, 0, 0, 0, 0, 0) * 1e3
brazil_imp <- c(35, 25, 25, 23) * 1e3
china_imp <- c(6.2, 6.2, 6.4, 5.7, 4.9, 4.8, 5.9) * 1e3
india_imp <- c(5.6, 5.6, 4.7, 6.4, 9.3, 9.5) * 1e3

imp[imp$country == "Chile", ]$Electricity_Imports <- chile_imp
imp[imp$country == "South Korea", ]$Electricity_Imports <- korea_imp
imp[imp$country == "Australia", ]$Electricity_Imports <- aus_imp
imp[imp$country == "Iceland", ]$Electricity_Imports <- isl_imp
imp[imp$country == "Japan", ]$Electricity_Imports <- jpn_imp
imp[imp$country == "Brazil", ]$Electricity_Imports <- brazil_imp
imp[imp$country == "China", ]$Electricity_Imports <- china_imp
imp[imp$country == "India", ]$Electricity_Imports <- india_imp

combined_data <- combined_data %>%
  filter(!is.na(Electricity_Imports)) %>%
  bind_rows(imp) %>%
  dplyr::select(-Electricity_Pumped_Storage)
```

```{r}
# 5. Total EV Sales and Stocks

# 5a. EV Sales
austria_sales <- combined_data %>%
  filter(country == "Austria") %>%
  mutate(log_sales = log(Total_Sales))

predict_austria <- austria_sales %>%
  dplyr::select(year, log_sales) %>%
  filter(is.na(log_sales)) %>%
  dplyr::select(-log_sales)

lm_austria <- lm(log_sales ~ year, data = austria_sales)
austria_sales$log_sales[is.na(austria_sales$log_sales)] <- predict(lm_austria, predict_austria)
austria_sales <- austria_sales %>%
  mutate(Total_Sales = round(exp(log_sales), 3)) %>%
  dplyr::select(-log_sales)

combined_data <- combined_data %>%
  filter(!country %in% c("Austria")) %>%
  bind_rows(austria_sales)


# 5b. EV Stocks
poland_stocks <- combined_data %>%
  filter(country == "Poland") %>%
  mutate(log_stocks = log(Total_Stocks))

predict_poland <- poland_stocks %>%
  dplyr::select(year, log_stocks) %>%
  filter(is.na(log_stocks)) %>%
  dplyr::select(-log_stocks)

lm_poland <- lm(log_stocks ~ year, data = poland_stocks)
poland_stocks$log_stocks[is.na(poland_stocks$log_stocks)] <- predict(lm_poland, predict_poland)
poland_stocks <- poland_stocks %>%
  mutate(Total_Stocks = round(exp(log_stocks), 3)) %>%
  dplyr::select(-log_stocks)

combined_data <- combined_data %>%
  filter(!country %in% c("Poland")) %>%
  bind_rows(poland_stocks)


sapply(combined_data, function(x) (sum(is.na(x))))

colnames(combined_data[sapply(combined_data, function(x) (sum(is.na(x)))) != 0])
```


##### More Setup: Additional Features, Splitting, and LASSO

- With that out of the way, we can proceed with the actual machine learning analysis, where we split the data into train/test sets, apply standard scaling on all numerical variables, and perform LASSO regularization to determine the best features. Finally, we can fit the regression model and do bidirectional stepwise selection.

- Maybe, we can also add extra variables that might be relevant. Namely, ratio of Renewable-to-Non-renewable and % of total electricity production that comes from renewables.

- Also, maybe temperature is a possible variable that affects EV usage. We suspect that too high or too low of a temperature could impact the batteries powering EVs and also the miles that the car could drive.


```{r}
# Remember:
# Total Renewables (Hydro, Geo, Solar, Wind, Other) = Hydro + Geo + Solar + Wind + Combustible Renewables + Other Renewables //
# Total Combustible Fuels // = Combustible Renewables + Oil and Petroleum Products + Other Combustible Non-Renewables // + Coal, Peat and Manufactured Gases + Natural Gas
# Electricity = Total Combustible Fuels + Total Renewables + Nuclear - Combustible Renewables

combined_data <- combined_data %>%
  mutate(percent_renewable_electricity = Renewables_Share / Electricity_Prod) %>%
  mutate(Non_Renewables_Share = Electricity_Prod - Renewables_Share) %>%
  mutate(ratio_renew_nonrenew = Renewables_Share / Non_Renewables_Share) %>%
  dplyr::select(-Non_Renewables_Share)

# Average temperature
temp <- read_csv("https://uwmadison.box.com/shared/static/cp4ialsg0ma771oip7hf0aujym2ktmtg.csv") %>%
  filter(Country %in% c(
    "Belgium", "Denmark", "Finland", "France", "Germany", "Italy", "Portugal",
    "Switzerland", "Greece", "Netherlands", "Norway", "Spain", "United Kingdom", "Sweden", "Iceland",
    "Austria", "Poland", "Canada", "Chile", "United States", "Mexico", "Brazil",
    "Korea, Rep.", "Australia", "Japan", "New Zealand", "Turkey", "China", "India"
  )) %>%
  mutate(Country = replace(Country, Country == "United Kingdom", "UK")) %>%
  mutate(Country = replace(Country, Country == "United States", "USA")) %>%
  mutate(Country = replace(Country, Country == "Korea, Rep.", "South Korea")) %>%
  rename(country = Country) %>%
  rename(year = Year) %>%
  rename(annual_tavg = `Annual Mean`) %>%
  dplyr::select(country, year, annual_tavg)

combined_data <- combined_data %>%
  mutate(region = case_when(
    country %in% c(
      "Belgium", "Denmark", "Finland", "France", "Germany", "Italy", "Portugal",
      "Switzerland", "Greece", "Netherlands", "Norway", "Spain", "UK", "Sweden", "Iceland",
      "Austria", "Poland"
    ) ~ "Europe",
    country %in% c("Canada", "USA", "Mexico") ~ "North America",
    country %in% c("Chile", "Brazil") ~ "South America",
    country %in% c("South Korea", "Japan", "Turkey", "China", "India") ~ "Asia",
    country %in% c("Australia", "New Zealand") ~ "Oceania"
  )) %>%
  left_join(temp, by = c("country", "year"))

# https://climateknowledgeportal.worldbank.org/
combined_data[combined_data$country == "China", ]$annual_tavg <- c(
  7.97, 7.93,
  8.12, 7.77,
  8.01, 7.9,
  8.21
)
combined_data[combined_data$country == "India", ]$annual_tavg <- c(
  25.37, 25.26,
  25.11, 25.05,
  24.9, 25.09
)

write_csv(combined_data, "combined_data.csv")

# combined_data = combined_data %>%
#   mutate(annual_tavg = case_when(
#     annual_tavg > 25 ~ "Hot",
#     annual_tavg >= 16 & annual_tavg < 25 ~ "Moderate",
#     annual_tavg < 16 ~ "Cold"
#   ))
# t = combined_data
#
# combined_data = t

combined_data <- combined_data %>%
  mutate(Non_Renewables_Share = Electricity_Prod - Renewables_Share) %>%
  # mutate(fast_slow_charge_sttns = charging_sttns_fast / charging_sttns_slow) %>%
  mutate(charge_sttns = charging_sttns_fast + charging_sttns_slow) %>%
  dplyr::select(-c(charging_sttns_fast, charging_sttns_slow))
combined_data
```

```{r}
set.seed(3431)

# Train/test split
split <- initial_split(combined_data, prop = c(0.7), strata = "country")
train_data <- split %>%
  training()

test_data <- split %>%
  testing()


# Feature scaling
train_data <- train_data %>%
  dplyr::select(-c(BEV_Sales, BEV_Stock, PHEV_Stock, PHEV_Sales, FCEV_Stock, FCEV_Sales)) %>%
  dplyr::select(country, year, Total_Sales, Total_Stocks, region, everything())

train_data$Nuclear_Share <- c(scale(train_data$Nuclear_Share))
train_data$percent_renewable_electricity <- c(scale(train_data$percent_renewable_electricity))
train_data$annual_tavg <- c(scale(train_data$annual_tavg))
train_data$charge_sttns <- c(scale(train_data$charge_sttns))
train_data$ratio_renew_nonrenew <- c(scale(train_data$ratio_renew_nonrenew))
train_data$Coal_Share <- c(scale(train_data$Coal_Share))
train_data$Combust_Renew_Share <- c(scale(train_data$Combust_Renew_Share))
train_data$Electricity_Prod <- c(scale(train_data$Electricity_Prod))
train_data$Geothermal_Share <- c(scale(train_data$Geothermal_Share))
train_data$Hydro_Share <- c(scale(train_data$Hydro_Share))
train_data$NaturalGas_Share <- c(scale(train_data$NaturalGas_Share))
train_data$OilPetrol_Share <- c(scale(train_data$OilPetrol_Share))
train_data$Solar_Share <- c(scale(train_data$Solar_Share))
train_data$Renewables_Share <- c(scale(train_data$Renewables_Share))
train_data$Wind_Share <- c(scale(train_data$Wind_Share))
train_data$Electricity_Distrib_Loss <- c(scale(train_data$Electricity_Distrib_Loss))
train_data$Electricity_Cons <- c(scale(train_data$Electricity_Cons))
train_data$Electricity_Exports <- c(scale(train_data$Electricity_Exports))
train_data$Electricity_Imports <- c(scale(train_data$Electricity_Imports))
train_data$Non_Renewables_Share <- c(scale(train_data$Non_Renewables_Share))


test_data <- test_data %>%
  dplyr::select(-c(BEV_Sales, BEV_Stock, PHEV_Stock, PHEV_Sales, FCEV_Stock, FCEV_Sales)) %>%
  dplyr::select(country, year, Total_Sales, Total_Stocks, region, everything())


test_data$Nuclear_Share <- c(scale(test_data$Nuclear_Share))
test_data$percent_renewable_electricity <- c(scale(test_data$percent_renewable_electricity))
test_data$annual_tavg <- c(scale(test_data$annual_tavg))
test_data$charge_sttns <- c(scale(test_data$charge_sttns))
test_data$ratio_renew_nonrenew <- c(scale(test_data$ratio_renew_nonrenew))
test_data$Coal_Share <- c(scale(test_data$Coal_Share))
test_data$Combust_Renew_Share <- c(scale(test_data$Combust_Renew_Share))
test_data$Electricity_Prod <- c(scale(test_data$Electricity_Prod))
test_data$Geothermal_Share <- c(scale(test_data$Geothermal_Share))
test_data$Hydro_Share <- c(scale(test_data$Hydro_Share))
test_data$NaturalGas_Share <- c(scale(test_data$NaturalGas_Share))
test_data$OilPetrol_Share <- c(scale(test_data$OilPetrol_Share))
test_data$Solar_Share <- c(scale(test_data$Solar_Share))
test_data$Renewables_Share <- c(scale(test_data$Renewables_Share))
test_data$Wind_Share <- c(scale(test_data$Wind_Share))
test_data$Electricity_Distrib_Loss <- c(scale(test_data$Electricity_Distrib_Loss))
test_data$Electricity_Cons <- c(scale(test_data$Electricity_Cons))
test_data$Electricity_Exports <- c(scale(test_data$Electricity_Exports))
test_data$Electricity_Imports <- c(scale(test_data$Electricity_Imports))
test_data$Non_Renewables_Share <- c(scale(test_data$Non_Renewables_Share))
```

```{r}
set.seed(3431)

y <- train_data$Total_Sales
x <- data.matrix(train_data[, colnames(train_data)[5:ncol(train_data)]])

# LASSO - Feature selection
cv_model <- cv.glmnet(x, y, alpha = 1)
best_lambda <- cv_model$lambda.min
plot(cv_model)

# Feature selection: According to best_lambda, we can exclude the '.' variables (these got reduced to 0)
coefficient_model <- coef(glmnet(x, y, alpha = 1, lambda = best_lambda))
selected_features <- rownames(coefficient_model)[coefficient_model@i[-1] + 1]

selected_features
```

- After the LASSO feature selection algorithm, we are just left with `region`, `Nuclear_share`, `percent_renewable_electricity`, `ratio_renew_nonrenew`, `annual_tavg`, and `charge_sttns`. 

- With the potentially important features being identified, we can fit the (log-)linear model.


##### Model 1: Linear Regression + Bi-directional Stepwise Selection

```{r}
set.seed(3431)

# Fitting a linear regression model with the selected variables above, optimized by bi-directional step-wise selection
formula_model <- as.formula(paste("log(Total_Sales) ~ 1 +", paste(selected_features, collapse = " + ")))
model_lm <- lm(formula_model, data = train_data) %>%
  stepAIC(direction = "both", trace = F)
summary(model_lm)

vif(model_lm)
```

- Going a step further, we also include run bi-directional stepwise selection to further nail the most significant factors. 

- In a model, it is important for us to check if there is any presence of multicollinearity as it could cause stability issues among coefficients. To do so, we use vif().

- Based on the $GVIF^{(\frac{1}{2*{DF}})}$ metric (Generalized Variance Inflation Factor or Generalized Collinearity Diagnostics), it appears that all the variables have values very close to 1. Thus, this implies that there are minimal correlation among the predictors. Very good news! Our model sets a great benchmark for further improvements.

- Let's look at the residual plot and unearth how this model fares against the validation and test set. 

```{r}
plot(model_lm, which = 1, main = "Model Fit")
```

```{r}
# Looking at Test set
set.seed(3431)

predictions <- predict(model_lm, newdata = test_data)
actuals <- log(test_data$Total_Sales)

# Mean Absolute Error (MAE)
mae <- mean(abs(predictions - actuals))

# Mean Squared Error (MSE)
mse <- mean((predictions - actuals)^2)

# Root Mean Squared Error (RMSE)
rmse <- sqrt(mse)

# R^2
rss <- sum((predictions - actuals)^2)
tss <- sum((actuals - mean(actuals))^2)
r_squared <- 1 - (rss / tss)

# Print results
cat("MAE: ", mae, "\n")
cat("MSE: ", mse, "\n")
cat("RMSE: ", rmse, "\n")
cat("R-squared: ", r_squared, "\n")
```

- Our residual plot tells us that the log-linear model is a suitable fit. E(e) = 0, the errors are distributed normally, and they generally have constant variance.

- Our R-squared for the test set is very similar to the training data. This is a sign that our model generalizes fairly well to unseen data.

- An $R^2$ score of around 0.4 is moderate, but we believe it is a very reasonable score because the response variable deals with a mixture of consumer behavior (income, preferences, etc.) and market conditions. These are difficult to accurately predict with just a linear model.

- Therefore, we will try to use a more advanced model next to see if we can improve on our scores. Perhaps, the underlying relationship isn't all that monotonous, which is not captured by this model.


##### Model 2: Stacking

- Stacking is exactly like it sounds: we stack different models on top of one another to build a meta-model whose input is the output of other base algorithms.

- We first create a list of models we want to use. Namely, k-Nearest Neighbors, Support Vector Machine with a radial basis kernel, and ridge.

- We chose kNN and SVM because on their own, they perform better than linear regression. Perhaps, combining them can provide a more optimized final model. Ridge is to regularize our model.

- Of course, to further improve the model, we have to perform hyperparameter tuning. Luckily for us, caretEnsemble's caretList() discretely does this for us, as specified by the tuneLength parameter.

- The caretStack takes our list of base algorithms and runs a glm (generalized linear model) on it to create a stacked model. 

```{r}
set.seed(3431)

fit_control <- trainControl(method = "cv", number = 5, savePredictions = "final")

all_in_one <-
  caretList(formula_model,
    data = train_data,
    trControl = fit_control,
    verbose = F,
    verbosity = 0,
    tuneList = list(
      svmRadial = caretModelSpec(method = "svmRadial", tuneLength = 5),
      knn = caretModelSpec(method = "kknn", tuneLength = 5),
      ridge = caretModelSpec(method = "ridge", tuneLength = 5)
    )
  )


ensemble_ctrl <- trainControl(method = "repeatedcv", number = 3, repeats = 5, savePredictions = "final")

all_models_ensemble <- caretStack(all_in_one, method = "glm", tuneLength = 5, trControl = ensemble_ctrl)

# all_models_ensemble

predictions <- predict(all_models_ensemble, test_data)
actuals <- log(test_data$Total_Sales)

mse <- sum((predictions - actuals)^2) / nrow(predictions)
rmse <- sqrt(mse)
mae <- mean(abs(predictions$pred - actuals))
rss <- sum((predictions - actuals)^2)
tss <- sum((actuals - mean(actuals))^2)
r_squared <- 1 - (rss / tss)

cat("MAE: ", mae, "\n")
cat("MSE: ", mse, "\n")
cat("RMSE: ", rmse, "\n")
cat("R-squared: ", r_squared, "\n")
```

- The results look promising! All goodness-of-fit metrics perform even better with our stacking model vs. our previous linear regression model. Our $R^2$ alone rose up by 38% from 0.42 to 0.58. 

- While it is not quite 0.8 or 0.9, we are satisfied because, to reiterate, consumer behavior and market conditions (which are very hard to quantify) also affect total EV sales share.   

- Thus, we would prefer to use this algorithm to find out, what factors are the best predictors of future EV adoption?


##### Feature Importance and PDP Plots

```{r, fig.height = 5, fig.width = 8}
# Since our stacking model does not provide a varImp() function straight out-of-the-box, we pivot by calculating individual
# variable importance and then average it out
pfun <- function(object, newdata) {
  # Need vector of predicted class probabilities when using  log-loss metric
  predict(object, newdata = newdata)
}

vi_1 <- vi(all_in_one$svmRadial,
  method = "permute", nsim = 10,
  target = "Total_Sales", metric = "RMSE",
  pred_wrapper = pfun,
  train = train_data
) %>%
  dplyr::select(-StDev)

vi_2 <- vi(all_in_one$knn,
  method = "permute", nsim = 10,
  target = "Total_Sales", metric = "RMSE",
  pred_wrapper = pfun,
  train = train_data
) %>%
  rename(Importance_2 = Importance) %>%
  dplyr::select(-StDev)

vi_3 <- vi(all_in_one$ridge,
  method = "permute", nsim = 10,
  target = "Total_Sales", metric = "RMSE",
  pred_wrapper = pfun,
  train = train_data
) %>%
  rename(Importance_3 = Importance) %>%
  dplyr::select(-StDev)


feature_importance <- vi_1 %>%
  inner_join(vi_2, by = "Variable") %>%
  inner_join(vi_3, by = "Variable") %>%
  mutate(Importance = (Importance + Importance_2 + Importance_3) / 3) %>%
  dplyr::select(-Importance_2, -Importance_3) %>%
  filter(Importance > 0) %>%
  mutate(Importance = round(Importance / sum(Importance) * 100, 2)) %>%
  mutate(Variable = replace(Variable, Variable == "percent_renewable_electricity", "Renewable Energy / Electricity (%)")) %>%
  mutate(Variable = replace(Variable, Variable == "annual_tavg", "Annual Mean Temp.")) %>%
  mutate(Variable = replace(Variable, Variable == "region", "Region")) %>%
  mutate(Variable = replace(Variable, Variable == "charge_sttns", "Charge Stations")) %>%
  mutate(Variable = replace(Variable, Variable == "Nuclear_Share", "Nuclear (Electricity Production)")) %>%
  mutate(Variable = replace(Variable, Variable == "ratio_renew_nonrenew", "Renewable-to-Nonrenewable"))

# Plot feature importance
feature_importance %>%
  ggplot(aes(y = reorder(Variable, -Importance, desc), x = Importance)) +
  geom_col(color = "black", fill = "deepskyblue4", alpha = 0.8) +
  labs(y = "", title = "Feature Importance", x = "Importance (%)") +
  xlim(c(0, 50)) +
  scale_x_continuous(expand = c(0, 0, 0.2, 0.1))
```


- It looks like `Renewable Energy / Electricity (%)` is the most important feature, followed by `Annual Mean Temp.`, `Region`, `Charge Stations`, `Nuclear (Electricity Production)` and `Renewable-to-Nonrenewable` . Let us do further analysis to understand how these features contribute to EV adoption.

- Here, we can use Partial Dependence Plots (PDPs). 

```{r, fig.height = 7, fig.width = 10}
pdp_list <- list()

for (i in vi_2$Variable[1:6]) {
  pdp_obj <- partial(all_models_ensemble,
    pred.var = c(i),
    train = train_data,
    grid.resolution = 100
  )

  pdp_list[[i]] <- pdp_obj
}

plot_1 <- pdp_list[[1]] %>%
  rename(`Renewable Energy / Electricity (%)` = percent_renewable_electricity) %>%
  rename(`Predicted EV Sales Share` = yhat) %>%
  ggplot(aes(x = `Renewable Energy / Electricity (%)`, y = `Predicted EV Sales Share`)) +
  geom_line(color = "deepskyblue4", size = 2, alpha = 0.8) +
  scale_x_continuous(sec.axis = dup_axis()) +
  theme(
    axis.text = element_text(size = 13),
    axis.text.x.top = element_blank(),
    axis.title.x.bottom = element_blank(),
    axis.title = element_text(size = 15),
    title = element_text(size = 15),
    legend.text = element_text(size = 13),
    legend.title = element_text(
      size = 15, margin =
        ggplot2::margin(t = 0, r = 20, b = 0, l = 0, unit = "pt")
    )
  ) +
  labs(y = "Pred. EV Sales Share")

plot_2 <- pdp_list[[2]] %>%
  rename(`Annual Mean Temp.` = annual_tavg) %>%
  rename(`Predicted EV Sales Share` = yhat) %>%
  ggplot(aes(x = `Annual Mean Temp.`, y = `Predicted EV Sales Share`)) +
  geom_line(color = "orangered2", size = 2, alpha = 0.8) +
  labs(y = "") +
  scale_x_continuous(sec.axis = dup_axis()) +
  theme(
    axis.text = element_text(size = 13),
    axis.text.x.top = element_blank(),
    axis.title.x.bottom = element_blank(),
    axis.title = element_text(size = 15),
    title = element_text(size = 15),
    legend.text = element_text(size = 13),
    legend.title = element_text(
      size = 15, margin =
        ggplot2::margin(t = 0, r = 20, b = 0, l = 0, unit = "pt")
    )
  )

plot_3 <- pdp_list[[3]] %>%
  rename(Region = region) %>%
  rename(`Predicted EV Sales Share` = yhat) %>%
  mutate(region = row_number()) %>%
  ggplot(aes(x = region, y = `Predicted EV Sales Share`)) +
  geom_col(fill = "deepskyblue4", color = "black", alpha = 0.8) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  labs(y = "", x = "Region") +
  scale_x_continuous(sec.axis = dup_axis(), breaks = 1:5, labels = pdp_list[[3]]$region) +
  theme(
    axis.text = element_text(size = 13),
    axis.text.x.top = element_blank(),
    axis.title.x.bottom = element_blank(),
    axis.title = element_text(size = 15),
    axis.text.x = element_text(angle = 45, hjust = 1),
    title = element_text(size = 15),
    legend.text = element_text(size = 13),
    legend.title = element_text(
      size = 15, margin =
        ggplot2::margin(t = 0, r = 20, b = 0, l = 0, unit = "pt")
    )
  )

plot_4 <- pdp_list[[4]] %>%
  rename(`Charge Stations` = charge_sttns) %>%
  rename(`Predicted EV Sales Share` = yhat) %>%
  ggplot(aes(x = `Charge Stations`, y = `Predicted EV Sales Share`)) +
  geom_line(color = "orangered2", size = 2, alpha = 0.8) +
  scale_x_continuous(sec.axis = dup_axis()) +
  theme(
    axis.text = element_text(size = 13),
    axis.text.x.top = element_blank(),
    axis.title.x.bottom = element_blank(),
    axis.title = element_text(size = 15),
    title = element_text(size = 15),
    legend.text = element_text(size = 13),
    legend.title = element_text(
      size = 15, margin =
        ggplot2::margin(t = 0, r = 20, b = 0, l = 0, unit = "pt")
    )
  ) +
  labs(y = "Pred. EV Sales Share")

plot_5 <- pdp_list[[5]] %>%
  rename(`Nuclear (Electricity Production)` = Nuclear_Share) %>%
  rename(`Predicted EV Sales Share` = yhat) %>%
  ggplot(aes(x = `Nuclear (Electricity Production)`, y = `Predicted EV Sales Share`)) +
  geom_line(color = "deepskyblue4", size = 2, alpha = 0.8) +
  labs(y = "") +
  scale_x_continuous(sec.axis = dup_axis()) +
  theme(
    axis.text = element_text(size = 13),
    axis.text.x.top = element_blank(),
    axis.title.x.bottom = element_blank(),
    axis.title = element_text(size = 15),
    title = element_text(size = 15),
    legend.text = element_text(size = 13),
    legend.title = element_text(
      size = 15, margin =
        ggplot2::margin(t = 0, r = 20, b = 0, l = 0, unit = "pt")
    )
  )


plot_6 <- pdp_list[[6]] %>%
  rename(`Renewable-to-Nonrenewable` = ratio_renew_nonrenew) %>%
  rename(`Predicted EV Sales Share` = yhat) %>%
  ggplot(aes(x = `Renewable-to-Nonrenewable`, y = `Predicted EV Sales Share`)) +
  geom_line(color = "orangered2", size = 2, alpha = 0.8) +
  labs(y = "") +
  scale_x_continuous(sec.axis = dup_axis()) +
  theme(
    axis.text = element_text(size = 13),
    axis.text.x.top = element_blank(),
    axis.title.x.bottom = element_blank(),
    axis.title = element_text(size = 15),
    axis.title.x = element_text(size = 15),
    title = element_text(size = 15),
    legend.text = element_text(size = 13),
    legend.title = element_text(
      size = 15, margin =
        ggplot2::margin(t = 0, r = 20, b = 0, l = 0, unit = "pt")
    )
  )


(plot_1 + plot_2 + plot_3) / (plot_4 + plot_5 + plot_6) +
  plot_annotation(title = "How the 6 Most Important Features Affect Total EV Sales Share")
```

- The PDP plots reveal the direction of the relationship between the EV sales share predictors and the response.

- From the graph above, we can see that EV sales share mainly rises when:
  - the percentage of renewable energy as part of total electricity production is high
  - the annual mean temperature is low
  - the country is situated in Europe (and also Oceania)
  - there are many charging station infrastructure (regardless of speed of charging)
  - the ratio of renewable-to-nonrenewable energy is high

- The `Nuclear (Electricity Production)` variable exhibits one of the more complex relationship. Too high then there is no impact to EV sales share, too low then there is a negative impact on EV adoption.

- Now that the importance of the features and its influence on EV adoption has been revealed, let's charge onwards to our final task: to unearth the countries that are best positioned to embrace the transition to EVs.


##### Countries best positioned to embrace the transition to EVs

- We use multiple methods to answer this: our own scoring and K-means clustering.

###### Method 1: Scoring 

```{r}
score = combined_data %>% 
  dplyr::select(country, region, year, Total_Sales, percent_renewable_electricity, annual_tavg, charge_sttns, Nuclear_Share, ratio_renew_nonrenew) %>% 
  mutate_at(c("percent_renewable_electricity", "annual_tavg", "charge_sttns", "Nuclear_Share", "ratio_renew_nonrenew"), scale) %>% 
  mutate(region_based_scores = 
           case_when(
             region == "Europe" ~ 0.5,
             region == "Oceania" ~ 0.4,
             region == "North America" ~ 0.3,
             region == "Asia" ~ 0.2,
             region == "South America" ~ 0.1
           )) %>% 
  mutate(
    composite_scores = 
      (0.39 * percent_renewable_electricity) +
      (- 0.23 * annual_tavg) +
      (0.2 * region_based_scores) +
      (0.11 * charge_sttns) +
      (0.04 * Nuclear_Share) +
      (0.03 * ratio_renew_nonrenew)) %>% 
  arrange(desc(composite_scores)) %>% 
  group_by(country, region) %>% 
  mutate(`Highest Score` = max(composite_scores), `Mean Score` = mean(composite_scores)) %>% 
  ungroup() %>% 
  filter(composite_scores > 0.5) %>% 
  group_by(country, region) %>% 
  dplyr::select(country, region, year, `Highest Score`, `Mean Score`) %>% 
  mutate(`Ready Since` = min(year)) %>% 
  dplyr::select(-year) %>% 
  distinct() %>% 
  rename(Country = country) %>% 
  rename(Region = region) %>%
  ungroup() %>% 
  arrange(desc(`Mean Score`)) %>% 
  dplyr::select(Country, Region, `Ready Since`, everything())

score
```
  

###### Method 2: Clustering

```{r, fig.width = 12, fig.height = 6}

set.seed(6969)

fit_cluster <- combined_data %>% 
  dplyr::select(country, region, year, Total_Sales, percent_renewable_electricity, annual_tavg, charge_sttns, Nuclear_Share, ratio_renew_nonrenew)  %>% 
  bind_cols(
    predict(dummyVars("~ region", data = combined_data), newdata = combined_data) %>%
      as.data.frame()
  ) %>% 
  dplyr::select(- c(region, country, year, Total_Sales)) %>% 
  mutate_at(c("percent_renewable_electricity", "annual_tavg", "charge_sttns", "Nuclear_Share", "ratio_renew_nonrenew",
              "regionAsia", "regionEurope", "regionNorth America", "regionOceania", "regionSouth America"), scale) %>% 
  kmeans(centers = 3)


clusters <- combined_data %>% 
  dplyr::select(country, region, year, Total_Sales, percent_renewable_electricity, annual_tavg, charge_sttns, Nuclear_Share, ratio_renew_nonrenew)  %>% 
  bind_cols(data.frame(fit_cluster$cluster)) %>%  
  rename(Cluster = fit_cluster.cluster)

centroids <- data.frame(fit_cluster$centers) %>%
  rownames_to_column("cluster") %>% 
  pivot_longer(-cluster, names_to = "Feature") %>% 
  mutate(Feature = replace(Feature, Feature == "percent_renewable_electricity", "Renewable Energy / Electricity (%)")) %>%
  mutate(Feature = replace(Feature, Feature == "annual_tavg", "Annual Mean Temp.")) %>%
  mutate(Feature = replace(Feature, Feature == "regionAsia", "Region: Asia")) %>%
  mutate(Feature = replace(Feature, Feature == "regionEurope", "Region: Europe")) %>%
  mutate(Feature = replace(Feature, Feature == "regionOceania", "Region: Oceania")) %>%
  mutate(Feature = replace(Feature, Feature == "regionNorth.America", "Region: NA")) %>%
  mutate(Feature = replace(Feature, Feature == "regionSouth.America", "Region: SA")) %>%
  mutate(Feature = replace(Feature, Feature == "charge_sttns", "Charge Stations")) %>%
  mutate(Feature = replace(Feature, Feature == "Nuclear_Share", "Nuclear (Electricity Production)")) %>%
  mutate(Feature = replace(Feature, Feature == "ratio_renew_nonrenew", "Renewable-to-Nonrenewable")) %>% 
  mutate(Feature = forcats::fct(Feature, levels = 
                                  c("Renewable Energy / Electricity (%)",
                                    "Annual Mean Temp.",
                                    "Region: Europe",
                                    "Region: Oceania",
                                    "Region: NA",
                                    "Region: Asia",
                                    "Region: SA",
                                    "Charge Stations",
                                    "Nuclear (Electricity Production)",
                                    "Renewable-to-Nonrenewable"
                                    ))) %>% 
  mutate(Feature = forcats::fct_rev(Feature))


ggplot(centroids) +
  geom_col(aes(value, Feature), width = 1, color = "black", fill = "orangered2", alpha = 0.8) +
  facet_wrap(~ reorder(cluster, value)) +
  labs(y = "", x = "Cluster Means", title = "Clusters")


```


```{r}
clusters  %>% 
  mutate(Cluster = as.factor(Cluster)) %>%
  filter(Cluster == "1") %>% 
  group_by(country, region) %>% 
  summarize(`Ready Since` = min(year)) %>% 
  rename(Country = country) %>% 
  rename(Region = region)
```

- Both methods agree very well with each other! That's great success!

- The countries that are best positioned to embrace the transition to EVs are:
  - Iceland
  - Norway
  - Canada
  - Austria
  - New Zealand
  - Sweden
  - Switzerland
  - Denmark
  - China
  - Finland

- An interesting observation is that all Scandinavian countries (in our available data) are included in the list above. This makes sense, because they are all moving towards carbon neutral nations, especially Norway (slated to be by 2030).

- Thus, one of the ways to achieve such goal is to use EVs, as they are greener than normal cars.

- One last thing, let's visualize this finding:

```{r, fig.width = 8}

best_countries <- combined_data %>%
  dplyr::select(country, region) %>% 
  distinct() %>% 
  mutate(Readiness = case_when(
    country %in% score$Country ~ "Ready",
    .default = "Not Quite Ready"
  ))
  
base_map <- world %>%
  ggplot(aes(x = long, y = lat, group = group)) +
  geom_polygon(color = "black", fill = "white") +
  theme(
    axis.text = element_blank()
  ) +
  labs(x = "", y = "")

ev_transition <- world %>%
  inner_join(best_countries, by = c("region" = "country"))

base_map +
  geom_polygon(data = ev_transition, aes(
    x = long, y = lat, group = group,
    fill = Readiness
  ), alpha = 0.8) +
  scale_fill_manual(values = c("orangered2", "deepskyblue4")) +
  labs(fill = "") +
  theme(legend.position = "bottom") +
  ggtitle("Readiness to Transition to EVs",
    subtitle = "As of 2021"
  )



```


---
